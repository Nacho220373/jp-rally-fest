<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¡JP Rally Fest - 22 Años!</title>
    <meta name="theme-color" content="#1e3a8a"/>
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- Estilos Visuales --- */
        body { font-family: 'Inter', sans-serif; background: linear-gradient(145deg, #2c5282 0%, #63b3ed 50%, #4299e1 100%); background-attachment: fixed; }
        .main-title, .card-title, #completionMessage h3 { font-family: 'Poppins', sans-serif; font-weight: 700; }
        .subtitle { font-family: 'Poppins', sans-serif; font-weight: 400; }
        h2.card-title { border-bottom-width: 2px; padding-bottom: 0.5rem; margin-bottom: 1.25rem; color: #2b6cb0; border-bottom-color: #93c5fd; }
        .card { background-color: rgba(255, 255, 255, 0.98); border-radius: 1rem; box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.1); padding: 1.5rem 2rem; margin-bottom: 2rem; border: none; }
        .btn { border-radius: 0.75rem; padding: 0.8rem 1.8rem; font-weight: 600; transition: all 0.3s ease; letter-spacing: 0.05em; cursor: pointer; text-align: center; border: none; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background: linear-gradient(135deg, #fcd34d 0%, #fbbf24 50%, #f59e0b 100%); color: #422006; }
        .btn-primary:hover:not(:disabled) { background: linear-gradient(135deg, #fde047 0%, #facc15 50%, #f59e0b 100%); transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); }
        .btn-start { background: linear-gradient(135deg, #34d399 0%, #10b981 50%, #059669 100%); color: white; padding: 1rem 2rem; font-size: 1.2rem; font-family: 'Poppins', sans-serif; }
        .btn-start:hover { background: linear-gradient(135deg, #6ee7b7 0%, #34d399 50%, #10b981 100%); transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); }
        .progress-bar-container { background-color: #e2e8f0; border-radius: 9999px; overflow: hidden; height: 24px; margin-bottom: 1.5rem; border: 1px solid #cbd5e1; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .progress-bar-fill { background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 100%); height: 100%; width: 0%; border-radius: 9999px; transition: width 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55); display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: white; font-size: 0.8rem; font-weight: 600; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }
        #currentMissionDisplay { background: linear-gradient(135deg, #e0f2fe 0%, #ffffff 100%); border: none; border-radius: 0.75rem; padding: 1.5rem; margin-top: 1.5rem; min-height: 110px; color: #1e3a8a; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); position: relative; overflow: hidden; }
        #currentMissionDisplay h3 { font-size: 1.3rem; font-weight: 700; margin-bottom: 0.75rem; color: #1e40af; display: flex; align-items: center; }
        #currentMissionDisplay h3 i { margin-right: 0.75rem; color: #3b82f6; }
        #currentMissionDisplay p { font-size: 1rem; line-height: 1.6; color: #4a5568; }
        #completionMessage { background: linear-gradient(135deg, #fef9c3 0%, #fde68a 100%); border: none; color: #854d0e; padding: 2.5rem; border-radius: 1rem; text-align: center; margin-top: 2rem; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden; }
        #completionMessage::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.1; pointer-events: none; }
        #completionMessage h3 { font-size: 2rem; font-weight: 700; margin-bottom: 1rem; color: #b45309; display: flex; align-items: center; justify-content: center; gap: 0.75rem; }
        #completionMessage .secret-phrase { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; font-size: 1.2rem; display: inline-block; margin-top: 1.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-shadow: 1px 1px 1px rgba(0,0,0,0.3); }
        .photo-placeholder { background-color: #bfdbfe; border: 2px dashed #60a5fa; display: flex; align-items: center; justify-content: center; height: 150px; border-radius: 0.5rem; color: #1e3a8a; flex-direction: column; text-align: center; }
        .message { border-left: 4px solid #fbbf24; padding: 0.75rem 1rem; margin-bottom: 1rem; background-color: #f0f9ff; border-radius: 0.25rem; }
        .jp-carousel { width: 100%; max-width: 800px; height: 450px; margin: 1.5rem auto; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); border: 3px solid white; padding: 10px 0; }
        .jp-carousel .swiper-wrapper { align-items: center; }
        .jp-carousel .swiper-slide { background-color: #1e3a8a; height: calc((100% - 30px) / 2); display: flex; justify-content: center; align-items: center; overflow: hidden; border-radius: 0.5rem; }
        .jp-carousel .swiper-slide img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 0.5rem; }
        .jp-carousel .swiper-button-next, .jp-carousel .swiper-button-prev { color: #fbbf24; background-color: rgba(30, 58, 138, 0.5); border-radius: 50%; width: 40px; height: 40px; transition: background-color 0.3s ease; }
        .jp-carousel .swiper-button-next:hover, .jp-carousel .swiper-button-prev:hover { background-color: rgba(30, 58, 138, 0.8); }
        .jp-carousel .swiper-button-next::after, .jp-carousel .swiper-button-prev::after { font-size: 18px; font-weight: bold; }
        .jp-carousel .swiper-pagination { position: absolute; bottom: 5px !important; }
        .jp-carousel .swiper-pagination-bullet { background-color: #dbeafe; opacity: 0.8; }
        .jp-carousel .swiper-pagination-bullet-active { background-color: #fbbf24; opacity: 1; }
        input[type="file"]::file-selector-button { background-color: #60a5fa; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.3s ease; font-weight: 500; }
        input[type="file"]::file-selector-button:hover { background-color: #3b82f6; }
        .rally-gallery-swiper { width: 100%; height: 420px; padding-top: 10px; padding-bottom: 30px; margin-left: auto; margin-right: auto; }
        .rally-gallery-swiper .swiper-wrapper { align-items: center; }
        .rally-gallery-swiper .swiper-slide { background-color: transparent; height: calc((100% - 40px) / 3); display: flex; justify-content: center; align-items: center; overflow: hidden; border-radius: 0.5rem; }
        .rally-gallery-swiper .swiper-slide img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
        .rally-gallery-swiper .swiper-slide img:hover { transform: scale(1.03); }
        .rally-gallery-swiper .swiper-pagination { position: absolute; bottom: 5px !important; }
        .rally-gallery-swiper .swiper-pagination-bullet { background-color: #60a5fa; opacity: 0.7; }
        .rally-gallery-swiper .swiper-pagination-bullet-active { background-color: #1e3a8a; opacity: 1; }
        #galleryLoading { text-align: center; padding: 2rem; color: #4a5568; font-style: italic; }
        #galleryError { text-align: center; color: #e53e3e; font-weight: 600; margin-top: 1rem; }

    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="text-center mb-4">
             <h1 class="text-4xl md:text-5xl main-title mb-2">¡JP Rally Fest!</h1>
             <p class="text-2xl md:text-3xl subtitle">Celebrando los 22 Años de JP</p>
        </header>

        <section id="jp-gallery" class="mb-12">
             <div class="swiper jp-carousel">
                 <div class="swiper-wrapper">
                     <div class="swiper-slide"><img src="https://i.postimg.cc/LJZ731Nr/01e6a2a4-1ad9-4d0b-b846-94ff39d62ffc.jpg" alt="[Foto de JP 1]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/xcPVbHpg/1479714907000443e9c57df07e206d1eaf01ae9a4187ae5e56aabda13f2497b6cfedf0a1bcd1f487e22fd907872b79ae450b.jpg" alt="[Foto de JP 2]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/Xr7SKJTW/1479715086000193ecad63701830a652168c66f0ea5ccb940b850030008430b5b6ae8bd9f80c37efe51ff81c0c3216468af9.jpg" alt="[Foto de JP 3]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/wyNSxssX/147985159100033a3208807f06e96bb8dd0537072af59273fdf60a8d35c01fa643937d16b0b95c4c26384d52b6628b5caa47.jpg" alt="[Foto de JP 4]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/CBWSmgbN/14801253675702b705bf67a84e83bf02d86cb375e9f446a5abd49c6a5f7b2f209b89ae6658c3e769448e6be517def3c45b31.jpg" alt="[Foto de JP 5]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/m1fW7SGp/1480125371490b60cb65797528f48c3e456e0c98f9ced74a3d6726f34987bd1a1e37ae3af412430d7dc37b076a4495d28a41.jpg" alt="[Foto de JP 6]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/zHK5Qcj1/14819350773691b998abe8197d2994fcb6333d562746f648eb34b21281c5bfa0f3d25a70d621f9ccdbe8ad6e9f3cc46ebf6e.jpg" alt="[Foto de JP 7]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/QF0Dv5pV/1483735338000352fd646361a01b451f2640806feaf892e8ac2830d6b97a14330ec5f284a21bf21152437b9a3f372ec867c8.jpg" alt="[Foto de JP 8]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/GBtRR2QK/1488683753000c7ff4b04c46424d08131bb942c1597e13ea0db069ae0a34227814cd39b0ba84b3f21ca130fac406e5304b1e.jpg" alt="[Foto de JP 9]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/JyFLzLYL/1494650410000b5abac7776ac99fb5f37e4b2922bb90bd5838d14234fd80b3a5ccb56493460f6b29c06a85e1004eae530be7.jpg" alt="[Foto de JP 10]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/mzFGc5KF/14961474570008f8c48a1f6a5c3f9710dbc0e77e1511d9142d37a207aa3b97bef0389b1b464e85e4411f7c7765b221146596.jpg" alt="[Foto de JP 11]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/rdKBbHVY/150890182000022452be76338c429a56f43ab2c7f5a7254674ab8d349c4e883cfb0ac4e710e5234694cb7a429cf53577b5d6.jpg" alt="[Foto de JP 12]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/bSj4ZNQK/1509828689000b3df605b41a73e239751f570fb000ce8b678d16b46c68f0575253a9268639b3fbcca09ce251f2d8e81590b9.jpg" alt="[Foto de JP 13]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/t1wKHz7R/1559360183000914db74c62d61df1b85462947c7a9ed4b52ac6fc6b5b93e4c9a2e86ada5224c6c19bac4dbfcc8c9f5989d1c.jpg" alt="[Foto de JP 14]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/3WgPPmh7/1564509129000a5aa70dda1fab245f58e37852524588e9ff3e575d3e5500fb69a7fe3add30abf11b4deb5e7a205d17b04341.jpg" alt="[Foto de JP 15]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/8f6PS5T9/20150403-141347.jpg" alt="[Foto de JP 16]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/k6ZXz8PW/20150729-172756.jpg" alt="[Foto de JP 17]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/mt4GDVjt/20161127-172454.jpg" alt="[Foto de JP 18]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/QF9LYPxY/21aae940-05c9-416b-8adc-69142f316e96.jpg" alt="[Foto de JP 19]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/m1R6bp44/27db8a45-dbde-445c-88b9-d26f2a3ba57a.jpg" alt="[Foto de JP 20]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/dhSX892R/2cefce3d-40a0-4d6b-8a23-a5ea9a26d3f2.jpg" alt="[Foto de JP 21]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/crv5d3yr/2-FE372-D2-4309-4-CBE-A1-CB-E839-E589-AEA4.jpg" alt="[Foto de JP 22]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/sM2qQLhD/5e88c655-affb-4c0f-8fc7-1e87c24abf6e.jpg" alt="[Foto de JP 23]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/LqcbW60n/637cfe8b-2ba5-4010-a2c7-b7be8fc2c3be.jpg" alt="[Foto de JP 24]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/Vdm31vst/668d6f4f-a16f-4de5-94a7-2c84160e47d2.jpg" alt="[Foto de JP 25]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/BLZMkLBZ/67985693-4401-4cb2-897a-d81448d95567.jpg" alt="[Foto de JP 26]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/3dwQmWMT/67a38946-e720-42e3-a09e-df5aedba15b5.jpg" alt="[Foto de JP 27]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/6TcN8nmc/70aa847a-7070-4615-9367-5a94d808e962.jpg" alt="[Foto de JP 28]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/9DT87jf2/71a202d7-c0e9-4bc2-af8b-2c6f6748624b.jpg" alt="[Foto de JP 29]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/xcsY4MG8/891f84b0-e5fa-4c34-9de8-06ba1f1e8914.jpg" alt="[Foto de JP 30]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/0b5Pncwh/8-D80-AB4-D-1-EA3-4331-BECB-27-AFA8-BE82-F9.jpg" alt="[Foto de JP 31]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/JDTPLrpN/9829-E845-1-BBF-4-CDB-A6-E6-F459276-CE512.jpg" alt="[Foto de JP 32]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/9zFnNSLP/9c22f2b5-c76c-44d0-b1e2-3d458eabd4d4.jpg" alt="[Foto de JP 33]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/jwQYQ7ds/b8dc65e5-620b-4956-959a-f9134ea31786.jpg" alt="[Foto de JP 34]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/Ffd6GJpM/b96c7617-af6d-4e76-bc37-9a5be7d9e9d6.jpg" alt="[Foto de JP 35]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/JDWWkq86/c4dd92f0-d0df-49b7-abfb-8bc2aea2a130.jpg" alt="[Foto de JP 36]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/p9JssY81/eeac4aaf-b144-48a1-b977-40b9c3d283d3.jpg" alt="[Foto de JP 37]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/w72nBz3G/f36a12a2-589e-4b60-bda0-15adb6a6f86f-1.jpg" alt="[Foto de JP 38]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/xJgF1y1b/f7b4d105-0bff-4e9f-9dc3-a8d29a0de141.jpg" alt="[Foto de JP 39]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/K42ZkZvG/f8558dc4-4bec-4348-b182-3ba048bbd4cd.jpg" alt="[Foto de JP 40]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/BLtnmpkq/IMG-20150408-WA0026.jpg" alt="[Foto de JP 41]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/kD658jWs/IMG-20150901-WA0002.jpg" alt="[Foto de JP 42]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/jWSxjvsz/IMG-20151025-WA0016.jpg" alt="[Foto de JP 43]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/B87qPD6R/IMG-20161125-WA0134.jpg" alt="[Foto de JP 44]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/bdtzdZjF/IMG-20170305-WA0007.jpg" alt="[Foto de JP 45]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/ppQRY3rf/IMG-20170413-WA0014.jpg" alt="[Foto de JP 46]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/Wd2j9SqQ/IMG-20170417-WA0005.jpg" alt="[Foto de JP 47]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/D837G7vf/IMG-20170706-WA0059.jpg" alt="[Foto de JP 48]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/w1fKwzpm/IMG-20180705-WA0008.jpg" alt="[Foto de JP 49]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/Thg6fBrz/IMG-20190423-WA0010.jpg" alt="[Foto de JP 50]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/vxrFh6YY/IMG-20190817-WA0001.jpg" alt="[Foto de JP 51]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/RJQyK5dq/IMG-20191219-WA0021.jpg" alt="[Foto de JP 52]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/vg1GrBxT/IMG-0169-2047675711.jpg" alt="[Foto de JP 53]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/Mv1K3vPj/IMG-0866.jpg" alt="[Foto de JP 54]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/JDj2CV9K/IMG-1513.avif" alt="[Foto de JP 55]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/DWxzQHCj/IMG-2037.jpg" alt="[Foto de JP 56]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/s1kgJpcr/IMG-2209-1173142498.jpg" alt="[Foto de JP 57]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/K1NcFCyG/IMG-2227.jpg" alt="[Foto de JP 58]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/k29M0qzY/IMG-2528-1528372763.jpg" alt="[Foto de JP 59]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/SjyBbjxM/IMG-3742.avif" alt="[Foto de JP 60]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/F1Vh027j/IMG-5186.avif" alt="[Foto de JP 61]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/pm4v2v6t/IMG-5767.jpg" alt="[Foto de JP 62]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://i.postimg.cc/RqsDrRYk/IMG-6129.avif" alt="[Foto de JP 63]" loading="lazy"></div>
                    <div class="swiper-slide"><img src="https://placehold.co/400x400/1e3a8a/ffffff?text=JP" alt="[JP]" loading="lazy"></div>
                 </div>
                <div class="swiper-pagination jp-carousel-pagination"></div>
                <div class="swiper-button-prev jp-carousel-prev"></div>
                <div class="swiper-button-next jp-carousel-next"></div>
            </div>
        </section>

        <section id="rallySection" class="card">
             <h2 class="text-2xl font-semibold mb-2 card-title border-b pb-2">🚨 JP RALLY – 10 MISIONES PARA GANARLO TODO 🚨</h2>
            <p class="mb-4 text-gray-600 text-sm">📸 Cumple cada reto con una foto como prueba. Termina los 10 y reclama tu premio de leyenda.</p>
            <div id="startRallyContainer" class="text-center">
                 <button id="startRallyButton" class="btn btn-start">
                     <i class="fas fa-play-circle mr-2"></i>Empezar Rally
                 </button>
            </div>
            <div id="progressBarContainer" class="progress-bar-container hidden">
                <div id="progressBarFill" class="progress-bar-fill">0%</div>
            </div>
            <div id="currentMissionDisplay" class="hidden">
                <p class="text-gray-500">Cargando misión...</p>
            </div>
        </section>

        <section id="fotosSection" class="card hidden">
             <h2 class="text-2xl font-semibold mb-4 card-title border-b pb-2"><i class="fas fa-camera-retro mr-2"></i> Sube la Prueba de tu Misión Actual</h2>
            <p class="mb-4 text-gray-700">Asegúrate de que la foto sea clara y cumpla el reto. ¡Solo tienes una oportunidad por misión!</p>
            <div class="mb-4">
                <label for="photoUpload" class="block text-sm font-medium text-gray-700 mb-1">Selecciona tu archivo:</label>
                <input type="file" id="photoUpload" name="photoUpload" accept="image/*" class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold"/>
            </div>
            <button id="uploadButton" class="btn btn-primary w-full"><i class="fas fa-upload mr-2"></i>Confirmar y Avanzar Misión</button>
            <div id="photoPreview" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            </div>
             <p id="uploadStatus" class="text-center text-blue-600 font-semibold mt-3"></p>
        </section>

        <section id="gallerySection" class="card hidden">
            <h2 class="text-2xl font-semibold mb-4 card-title border-b pb-2"><i class="fas fa-images mr-2"></i> Galería del Rally</h2>
            <div id="galleryLoading" class="text-center text-gray-500 py-4">
                <i class="fas fa-spinner fa-spin mr-2"></i> Cargando fotos...
            </div>
            <div class="swiper rally-gallery-swiper">
                <div class="swiper-wrapper" id="rallyGalleryWrapper">
                    </div>
                <div class="swiper-pagination rally-gallery-pagination"></div> </div>
            <p id="galleryError" class="text-center text-red-600 font-semibold mt-3 hidden"></p>
        </section>

        <section id="mensajesSection" class="card hidden">
              <h2 class="text-2xl font-semibold mb-4 card-title border-b pb-2"><i class="fas fa-check-double mr-2"></i> ¡Rally Completado! Ahora el Mensaje Final</h2>
            <p class="mb-4 text-gray-700">¡Lo lograste! Antes de reclamar tu premio, déjale unas palabras al festejado.</p>
            <div class="mb-4">
                <label for="guestName" class="block text-sm font-medium text-gray-700 mb-1">Tu Nombre:</label>
                <input type="text" id="guestName" name="guestName" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="mb-4">
                <label for="messageText" class="block text-sm font-medium text-gray-700 mb-1">Tu Mensaje para JP:</label>
                <textarea id="messageText" name="messageText" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="¡Escribe tus buenos deseos aquí!" required></textarea>
             </div>
            <button id="sendMessageButton" class="btn btn-primary w-full"><i class="fas fa-paper-plane mr-2"></i>Enviar Mensaje y Ver Premio</button>
            <div id="messageBoard" class="mt-6 space-y-4 hidden">
                  <h3 class="text-xl font-semibold text-blue-900 mt-4">Muro de Mensajes:</h3>
                <div class="message">
                    <p class="text-gray-700">¡Feliz cumpleaños, JP! ¡Que te la pases genial!</p>
                    <p class="text-sm text-gray-600 font-semibold">- Amigo Ejemplo</p>
                </div>
            </div>
        </section>

         <section id="completionMessage" class="card hidden">
         </section>

        <footer class="text-center mt-8 text-blue-100 text-sm">
            <p>&copy; <span id="year"></span> JP Rally Fest. ¡A celebrar!</p>
        </footer>

    </div> <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

    <script>
        // --- PWA: Registrar Service Worker ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
              .then(registration => { console.log('SW registrado:', registration.scope); })
              .catch(error => { console.log('Error registro SW:', error); });
          });
        }

        // --- Configuración Supabase ---
        const SUPABASE_URL = 'https://ojlknkrrxobtiqhhkrad.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qbGtua3JyeG9idGlxaGhrcmFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMTA1NTIsImV4cCI6MjA2MDU4NjU1Mn0.c0C9zLsm34_654XjO-jzkqdBq4I9trkW0Oqd1A361XM';

        let supabase = null;
        try {
            if (window.supabase && typeof window.supabase.createClient === 'function') {
                 supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                 console.log("Cliente Supabase inicializado.");
            } else {
                throw new Error("La librería Supabase (supabase-js) no se cargó correctamente.");
            }
        } catch (error) {
            console.error("Error inicializando Supabase:", error);
            const body = document.querySelector('body');
            if (body) {
                const errorDiv = document.createElement('div');
                errorDiv.textContent = `Error crítico al conectar con Supabase: ${error.message}. Por favor, revisa la consola y recarga.`;
                errorDiv.style.backgroundColor = 'red'; errorDiv.style.color = 'white'; errorDiv.style.padding = '1rem';
                errorDiv.style.position = 'fixed'; errorDiv.style.top = '0'; errorDiv.style.left = '0';
                errorDiv.style.width = '100%'; errorDiv.style.zIndex = '9999'; errorDiv.style.textAlign = 'center';
                body.prepend(errorDiv);
            }
        }

        // --- Lógica del Rally ---
        const rallyMissions = [
            { title: "1️⃣ Foto con el cumpleañero", description: "La misión clásica. Haz una selfie con el cumpleañero haciendo una cara loquísima o ridícula. ¡Nada de poses normales!" },
            { title: "2️⃣ Recrea una foto del carrusel", description: "Elige una de las fotos que viste antes en el carrusel e intenta copiarla exactamente: poses, caras, actitud. ¡Puntos extra por precisión!" },
            { title: "3️⃣ Shot de tu licor favorito", description: "No hay fiesta sin shots. Tómate uno del licor que más te gusta… o te destruye. Foto del momento, no vale después." },
            { title: "4️⃣ Toma grupal (mínimo 3 personas)", description: "Consigue que mínimo 3 personas hagan un brindis y se lo tomen al mismo tiempo. ¡Foto en el mero momento!" },
            { title: "5️⃣ Foto incómoda con alguien", description: "Acércate demasiado, abraza raro, pon cara extraña. El objetivo es que al ver esa foto mañana digas: “¿por qué hicimos eso?”." },
            { title: "6️⃣ Predicción del destino: Nacho y JP", description: "Haz una foto actuada de cómo crees que van a terminar Nacho y JP al final de la fiesta (tirados, abrazados, dormidos, peleando, etc)." },
            { title: "7️⃣ Outfit alterado", description: "Cámbiate algo en tu ropa: ponte una prenda ajena, voltea la camiseta, añade algo ridículo. El punto es que se note que pasó algo. ¡Foto posando con actitud!" },
            { title: "8️⃣ Boda exprés", description: "Declárate, cásate, intercambia anillos falsos y dale un beso (o abrazo) a tu nuevo amor. ¡Foto oficial de la boda improvisada!" },
            { title: "9️⃣ Cara de 'ya me arrepentí'", description: "Captura el momento después de un shot fuerte, una mala decisión, o simplemente el caos mental. ¡La cara lo dice todo!" },
            { title: "🔟 Algo con JP", description: "Encuentra a JP y tómate una foto haciendo algo legendario: un brindis, un baile, una escena de película. Solo vale si JP aparece en la foto." }
        ];
        const secretPhrases = ["El pastel de chocolate es la clave", "Dile a JP que traigo el tesoro perdido", "La piña colada sabe a victoria", "El karaoke espera al campeón", "Pregunta por el patito de hule dorado", "El flamingo rosa conoce el camino", "Solo los dignos beben del cáliz azul", "La contraseña es 'más tequila'", "El mapa está bajo la servilleta", "Busca al invitado con calcetines diferentes", "El DJ tiene un mensaje para ti", "Susurra 'Aguacate' tres veces", "El verdadero tesoro son los amigos... y el premio", "La chancla voladora es mi señal", "El ajolote fiestero te guiará", "¿Dónde está el botón de autodestrucción?", "El guacamole necesita más limón", "Mi espíritu animal es un taco al pastor", "La conga empieza a medianoche", "Necesito más brillantina en mi vida", "El perro se comió mi dignidad", "Que la fuerza (del shot) te acompañe", "Declaro esta cocina territorio independiente", "El confeti es mi lenguaje de amor", "Soy el campeón indiscutible de las miradas incómodas", "Mi superpoder es pedir otra ronda", "El mezcal me susurra secretos", "Vine por el pastel, me quedé por el chisme", "La cumbia me posee", "Advertencia: puedo empezar a bailar sin previo aviso", "El secreto está en la masa... de la pizza", "Busco socio para conquistar la pista de baile", "Mi plan B es echarle la culpa al alcohol", "¿Alguien ha visto mi unicornio?", "El limón y la sal son mis mejores amigos", "Necesito un café... o cinco tequilas", "Soy alérgico a la falta de fiesta", "El chiste se cuenta solo... después del tercer shot", "Mi propósito en la vida es encontrar snacks", "Que no pare la fiesta, hasta que amanezca... o me duerma", "El mariachi loco quiere bailar contigo", "La vida es corta, come postre primero", "Soy como un Gremlin, no me mojes con agua simple", "El ritmo de la noche me llama", "Mi talento oculto es desaparecer misteriosamente", "Busco almas gemelas... para compartir los nachos", "El que no arriesga, no gana... ni bebe gratis", "Declaro inaugurada la temporada de brindis", "Mi color favorito es el neón de la fiesta", "La última croqueta siempre es la más peleada"];
        const rallySection = document.getElementById('rallySection');
        const startRallyContainer = document.getElementById('startRallyContainer');
        const startRallyButton = document.getElementById('startRallyButton');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBarFill = document.getElementById('progressBarFill');
        const currentMissionDisplay = document.getElementById('currentMissionDisplay');
        const fotosSection = document.getElementById('fotosSection');
        const photoUploadInput = document.getElementById('photoUpload');
        const uploadButton = document.getElementById('uploadButton');
        const uploadStatus = document.getElementById('uploadStatus');
        const photoPreview = document.getElementById('photoPreview');
        const mensajesSection = document.getElementById('mensajesSection');
        const guestNameInput = document.getElementById('guestName');
        const messageTextInput = document.getElementById('messageText');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const completionMessageDiv = document.getElementById('completionMessage');
        const gallerySection = document.getElementById('gallerySection');
        const galleryLoading = document.getElementById('galleryLoading');
        const rallyGalleryWrapper = document.getElementById('rallyGalleryWrapper');
        const galleryError = document.getElementById('galleryError');

        let currentMissionIndex = 0;
        const totalMissions = rallyMissions.length;
        let rallyStarted = false;
        let rallyGallerySwiper = null;

        // --- Funciones de UI y Estado ---
        function updateRallyUI() {
            const messageSent = localStorage.getItem('jpRallyMessageSent') === 'true';
            startRallyContainer.classList.add('hidden');
            progressBarContainer.classList.add('hidden');
            currentMissionDisplay.classList.add('hidden');
            fotosSection.classList.add('hidden');
            mensajesSection.classList.add('hidden');
            completionMessageDiv.classList.add('hidden');
            // La galería se muestra/oculta en initialize y fetch

            if (!rallyStarted && !messageSent) {
                startRallyContainer.classList.remove('hidden');
                gallerySection.classList.add('hidden');
            } else if (currentMissionIndex < totalMissions && !messageSent) {
                progressBarContainer.classList.remove('hidden');
                currentMissionDisplay.classList.remove('hidden');
                fotosSection.classList.remove('hidden');
                gallerySection.classList.remove('hidden');
                const progressPercentage = Math.round((currentMissionIndex / totalMissions) * 100);
                progressBarFill.style.width = `${progressPercentage}%`;
                progressBarFill.textContent = `${progressPercentage}% (${currentMissionIndex}/${totalMissions})`;
                const mission = rallyMissions[currentMissionIndex];
                currentMissionDisplay.innerHTML = `
                    <h3><i class="fas fa-flag-checkered mr-2"></i> Misión ${currentMissionIndex + 1}: ${mission.title}</h3>
                    <p>${mission.description}</p>
                `;
                uploadButton.disabled = false;
                uploadStatus.textContent = '';
                photoUploadInput.value = '';
                photoPreview.innerHTML = '';
            } else if (currentMissionIndex === totalMissions && !messageSent) {
                 mensajesSection.classList.remove('hidden');
                 progressBarContainer.classList.remove('hidden');
                 progressBarFill.style.width = `100%`;
                 progressBarFill.textContent = `100% (${totalMissions}/${totalMissions})`;
                 gallerySection.classList.remove('hidden');
            } else {
                 completionMessageDiv.classList.remove('hidden');
                 gallerySection.classList.remove('hidden');
                 if (!completionMessageDiv.innerHTML.includes('Felicidadeeeeeeees')) {
                     console.log("Generando mensaje de completado...");
                     const randomPhraseIndex = Math.floor(Math.random() * secretPhrases.length);
                     console.log("Array length:", secretPhrases.length, "Random index:", randomPhraseIndex);
                     const secretPhrase = secretPhrases[randomPhraseIndex];
                     console.log("Selected phrase:", secretPhrase);
                     completionMessageDiv.innerHTML = `
                         <h3><i class="fas fa-trophy mr-2 text-yellow-500"></i> ¡Felicidadeeeeeeees! <i class="fas fa-trophy ml-2 text-yellow-500"></i></h3>
                         <p>¡Has completado todas las misiones del JP Rally y te has ganado tu premio de leyenda!</p>
                         <p class="mt-4">Para reclamarlo, ve a la cocina y di la siguiente frase secreta:</p>
                         <div class="secret-phrase">${secretPhrase}</div>
                     `;
                 }
            }
        }

        // --- Función Galería ---
        async function fetchAndDisplayPhotos() {
            if (!supabase) { gallerySection.classList.add('hidden'); return; }
            galleryLoading.classList.remove('hidden'); galleryError.classList.add('hidden');
            if (rallyGallerySwiper) { rallyGallerySwiper.removeAllSlides(); } else { rallyGalleryWrapper.innerHTML = ''; }
            try {
                const { data: photos, error } = await supabase.from('pruebas_rally').select('url_foto, numero_mision').order('created_at', { ascending: false }).limit(30);
                if (error) {
                    if (error.message.includes('relation "public.pruebas_rally" does not exist')) { throw new Error("La tabla 'pruebas_rally' no existe."); }
                    else if (error.message.includes('security policy')) { throw new Error("Permiso denegado para leer fotos (RLS)."); }
                    else { throw error; }
                }
                galleryLoading.classList.add('hidden');
                if (photos && photos.length > 0) {
                    gallerySection.classList.remove('hidden');
                    const slidesHTML = photos.map(photo => `<div class="swiper-slide"><img src="${photo.url_foto}" alt="Prueba Misión ${photo.numero_mision || '?'}" loading="lazy"></div>`).join('');
                    rallyGalleryWrapper.innerHTML = slidesHTML;
                    if (rallyGallerySwiper) { rallyGallerySwiper.update(); }
                    else {
                        rallyGallerySwiper = new Swiper('.rally-gallery-swiper', { slidesPerView: 3, slidesPerGroup: 3, grid: { rows: 3, fill: 'row' }, spaceBetween: 10, loop: false, autoplay: { delay: 3000, disableOnInteraction: true }, pagination: { el: '.rally-gallery-swiper .swiper-pagination', clickable: true, type: 'bullets' }, });
                    }
                } else {
                     rallyGalleryWrapper.innerHTML = '<p class="text-center text-gray-500 w-full">Aún no se han subido fotos.</p>';
                     if (rallyGallerySwiper) { rallyGallerySwiper.destroy(true, true); rallyGallerySwiper = null; }
                     gallerySection.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error cargando galería:', error); galleryLoading.classList.add('hidden'); galleryError.textContent = `Error al cargar la galería: ${error.message}`; galleryError.classList.remove('hidden'); gallerySection.classList.remove('hidden');
                 if (rallyGallerySwiper) { rallyGallerySwiper.destroy(true, true); rallyGallerySwiper = null; }
            }
        }

        // --- Inicialización Rally ---
        function initializeRally() {
             rallyStarted = localStorage.getItem('jpRallyStarted') === 'true';
            const savedProgress = localStorage.getItem('jpRallyProgress');
            const messageSent = localStorage.getItem('jpRallyMessageSent') === 'true';
            if (messageSent) { rallyStarted = true; currentMissionIndex = totalMissions + 1; }
            else if (rallyStarted && savedProgress !== null) {
                 currentMissionIndex = parseInt(savedProgress, 10);
                 if (isNaN(currentMissionIndex) || currentMissionIndex < 0 || currentMissionIndex > totalMissions) { currentMissionIndex = 0; localStorage.setItem('jpRallyProgress', '0'); }
            } else { rallyStarted = false; currentMissionIndex = 0; localStorage.removeItem('jpRallyProgress'); localStorage.removeItem('jpRallyMessageSent'); localStorage.setItem('jpRallyStarted', 'false'); }
            console.log("Rally inicializado. Iniciado:", rallyStarted, "Misión actual:", currentMissionIndex);
             if (supabase) { updateRallyUI(); fetchAndDisplayPhotos(); }
             else { startRallyContainer?.classList.remove('hidden'); startRallyButton?.setAttribute('disabled', 'true'); if(startRallyButton) startRallyButton.textContent = 'Error de Conexión'; gallerySection.classList.add('hidden'); }
        }

        // --- Event Listeners ---
        startRallyButton.addEventListener('click', () => {
             if (!rallyStarted && supabase) {
                console.log("Botón Empezar Rally presionado.");
                rallyStarted = true;
                currentMissionIndex = 0; // Forzar índice a 0
                localStorage.setItem('jpRallyStarted', 'true');
                localStorage.setItem('jpRallyProgress', '0');
                localStorage.removeItem('jpRallyMessageSent');
                console.log("Estado después de empezar:", { rallyStarted, currentMissionIndex });
                updateRallyUI();
            } else if (!supabase) { alert("Error: No se pudo iniciar el rally. Revisa la conexión."); }
        });

        uploadButton.addEventListener('click', async () => {
            if (!rallyStarted || currentMissionIndex >= totalMissions || !supabase) return;
            const file = photoUploadInput.files[0];
            if (!file) { alert('Por favor, selecciona una foto como evidencia.'); return; }
            uploadStatus.textContent = 'Subiendo prueba...'; uploadButton.disabled = true;
            const userId = `invitado_${Date.now()}`; const fileName = `${userId}/mision_${currentMissionIndex + 1}_${Date.now()}_${file.name}`; const bucketName = 'pruebas-rally';
            try {
                const { data: uploadData, error: uploadError } = await supabase.storage.from(bucketName).upload(fileName, file, { cacheControl: '3600', upsert: false });
                if (uploadError) throw uploadError;
                console.log('Archivo subido:', uploadData); uploadStatus.textContent = '¡Prueba subida con éxito!';
                 try {
                     const { data: urlData } = supabase.storage.from(bucketName).getPublicUrl(fileName);
                     if (!urlData || !urlData.publicUrl) throw new Error("No se pudo obtener la URL pública del archivo.");
                     const publicURL = urlData.publicUrl; console.log("URL Pública:", publicURL);
                     const { data: dbData, error: dbError } = await supabase.from('pruebas_rally').insert([ { numero_mision: currentMissionIndex + 1, url_foto: publicURL, identificador_invitado: userId } ]);
                     if (dbError) { console.error("Error CRÍTICO guardando prueba en DB:", dbError); throw new Error(`Error guardando registro de foto: ${dbError.message}`); }
                     else { console.log("Registro de prueba guardado en DB:", dbData); fetchAndDisplayPhotos(); }
                 } catch(dbOrUrlError) { console.error("Excepción al guardar prueba en DB u obtener URL:", dbOrUrlError); throw dbOrUrlError; }
                currentMissionIndex++; localStorage.setItem('jpRallyProgress', currentMissionIndex.toString());
                setTimeout(() => { updateRallyUI(); }, 1000);
            } catch (error) {
                console.error('Error en proceso de subida:', error); let errorMessage = error.message;
                 if (error.message?.includes('security policy')) errorMessage = "Permiso denegado (RLS).";
                 else if (error.message?.includes('relation') && error.message?.includes('does not exist')) errorMessage = "Tabla 'pruebas_rally' no existe.";
                 else if (error.message?.includes('Bucket not found')) errorMessage = "Bucket 'pruebas-rally' no existe.";
                uploadStatus.textContent = `Error: ${errorMessage}`; alert(`Error al subir la prueba: ${errorMessage}`); uploadButton.disabled = false;
            }
        });

        sendMessageButton.addEventListener('click', async () => {
            const name = guestNameInput.value.trim() || "Invitado Anónimo"; const message = messageTextInput.value.trim();
            if (!message) { alert('Por favor, escribe tu mensaje para JP.'); return; }
            if (rallyStarted && currentMissionIndex === totalMissions && localStorage.getItem('jpRallyMessageSent') !== 'true' && supabase) {
                sendMessageButton.disabled = true; sendMessageButton.textContent = "Enviando...";
                try {
                    const { data, error } = await supabase.from('mensajes').insert([{ nombre_invitado: name, texto_mensaje: message }]);
                    if (error) throw error;
                    console.log('Mensaje guardado en Supabase:', data); localStorage.setItem('jpRallyMessageSent', 'true'); currentMissionIndex++; localStorage.setItem('jpRallyProgress', currentMissionIndex.toString()); updateRallyUI(); alert('¡Mensaje enviado con éxito!');
                } catch (error) {
                    console.error('Error enviando mensaje:', error); let errorMessage = error.message;
                     if (error.message?.includes('security policy')) errorMessage = "Permiso denegado (RLS).";
                     else if (error.message?.includes('relation') && error.message?.includes('does not exist')) errorMessage = "Tabla 'mensajes' no existe.";
                     else if (error.code === '22P02') errorMessage = "Error de tipo de dato (nombre).";
                    alert(`Error al enviar el mensaje: ${errorMessage}`); sendMessageButton.disabled = false; sendMessageButton.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Enviar Mensaje y Ver Premio';
                }
            } else {
                 console.error("Intento de enviar mensaje en estado incorrecto o Supabase no inicializado.");
                 if (!supabase) alert("Error: No se pudo conectar con el sistema."); else alert("Error: No se puede enviar el mensaje en este momento.");
            }
        });


        // --- Inicialización General ---
        document.getElementById('year').textContent = new Date().getFullYear();
        const mainSwiper = new Swiper('.jp-carousel', {
            slidesPerView: 3,
            slidesPerGroup: 3,
            grid: { rows: 2, fill: 'row' },
            spaceBetween: 10,
            loop: false, // Loop desactivado para grid
            autoplay: { delay: 4000, disableOnInteraction: false },
            pagination: { el: '.jp-carousel .swiper-pagination', clickable: true },
            navigation: { nextEl: '.jp-carousel .swiper-button-next', prevEl: '.jp-carousel .swiper-button-prev' },
        });
        // Inicializar rally
        initializeRally();

    </script>

    </body>
</html>
