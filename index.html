<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galería de Imágenes PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para la cuadrícula de imágenes */
        .gallery-item {
            position: relative;
            cursor: pointer;
            overflow: hidden; /* Asegura que el checkbox no se salga */
            border-radius: 0.375rem; /* Esquinas redondeadas */
            border: 2px solid transparent; /* Borde inicial transparente */
            transition: border-color 0.2s ease-in-out;
        }
        .gallery-item img {
            display: block;
            width: 100%;
            height: 150px; /* Altura fija para las imágenes en la cuadrícula */
            object-fit: cover; /* Cubre el espacio manteniendo la relación de aspecto */
            transition: transform 0.3s ease;
        }
        .gallery-item:hover img {
            transform: scale(1.05);
        }
        /* Estilo para indicar selección */
        .gallery-item.selected {
            border-color: #3b82f6; /* Borde azul al seleccionar */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        /* Checkbox de selección (oculto visualmente, usamos el estado .selected) */
        .gallery-item input[type="checkbox"] {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 10; /* Asegura que esté por encima de la imagen */
            opacity: 0.8; /* Algo visible para depuración si es necesario */
        }
         /* Estilo visible para el checkbox (opcional, si no se usa .selected) */
         .gallery-item input[type="checkbox"]::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 20px;
            height: 20px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            opacity: 0.7; /* Hacerlo semi-transparente */
         }
         .gallery-item input[type="checkbox"]:checked::after {
            content: '✔';
            position: absolute;
            top: 0px;
            left: 3px;
            font-size: 16px;
            color: #3b82f6;
            opacity: 1;
         }


        /* Estilos para el Modal (Lightbox) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .modal img {
            max-width: 90%;
            max-height: 85%;
            object-fit: contain;
            border-radius: 4px;
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 30px;
            color: white;
            cursor: pointer;
            background: none;
            border: none;
        }
        /* Placeholder styling */
        .placeholder {
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 0.875rem;
            height: 150px; /* Misma altura que las imágenes */
            width: 100%;
            border-radius: 0.375rem;
            text-align: center;
            padding: 1rem;
        }
        /* Estilo para el botón de descarga */
        #downloadButton {
            transition: background-color 0.3s ease;
        }
        #downloadButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Estilo para el mensaje de estado de descarga */
        #downloadStatus {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #4b5563; /* gris */
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="container mx-auto max-w-7xl bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Galería de Imágenes</h1>
            <button id="downloadButton" disabled class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                Descargar Seleccionadas (<span id="selectedCount">0</span>)
            </button>
        </div>
        <div id="downloadStatus" class="text-sm text-gray-600 mb-4 h-5"></div> <div id="galleryContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            </div>
    </div>

    <div id="imageModal" class="modal">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <img id="modalImage" src="" alt="Imagen Ampliada">
    </div>

    <script>
        // --- Configuración ---
        const imageUrls = [
            // URLs proporcionadas anteriormente... (lista larga omitida por brevedad)
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745118072317/mision_1_1745118072317_IMG_3782.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745118304280/mision_1_1745118304280_IMG_2989.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745118512044/mision_2_1745118512044_IMG_3784.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745119308132/mision_1_1745119308132_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745119374397/mision_3_1745119374397_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745119379926/mision_2_1745119379926_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745119498491/mision_3_1745119498491_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745119825594/mision_4_1745119825594_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745120427534/mision_2_1745120427534_IMG_2992.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745120802585/mision_5_1745120802585_IMG_4830.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745120857539/mision_6_1745120857539_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745120927382/mision_7_1745120927382_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745121014491/mision_8_1745121014491_IMG_4835.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745121071585/mision_9_1745121071585_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745121286938/mision_10_1745121286938_IMG_4837.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745121754234/mision_1_1745121754234_IMG_9827.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745121857388/mision_4_1745121857388_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745121988919/mision_5_1745121988919_IMG_3788.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122002813/mision_1_1745122002813_IMG_2539.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122009173/mision_1_1745122009173_IMG_9827.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122048453/mision_2_1745122048453_IMG_9828.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122086922/mision_2_1745122086922_IMG_2540.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122134678/mision_3_1745122134678_IMG_9829.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122163736/mision_3_1745122163736_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122168892/mision_6_1745122168892_IMG_3790.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122188448/mision_4_1745122188448_IMG_9830.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122209204/mision_4_1745122209204_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122260844/mision_5_1745122260844_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122373931/mision_6_1745122373931_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122394409/mision_7_1745122394409_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122452571/mision_5_1745122452571_IMG_9831.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122459541/mision_7_1745122459541_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122534358/mision_8_1745122534358_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122560644/mision_9_1745122560644_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122604655/mision_8_1745122604655_IMG_3794.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122627718/mision_10_1745122627718_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122651668/mision_6_1745122651668_IMG_9832.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122753140/mision_1_1745122753140_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122839297/mision_2_1745122839298_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122857889/mision_9_1745122857889_IMG_3812.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122876838/mision_7_1745122876838_IMG_9835.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122939139/mision_8_1745122939139_IMG_9839.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745122990444/mision_9_1745122990444_IMG_9842.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745123007111/mision_10_1745123007111_IMG_3815.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745123096434/mision_10_1745123096434_IMG_9843.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745123236181/mision_1_1745123236181_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745123417530/mision_2_1745123417530_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745123473849/mision_3_1745123473849_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745123550864/mision_4_1745123550865_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745125674738/mision_1_1745125674738_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745125794876/mision_2_1745125794876_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129262370/mision_5_1745129262371_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129295147/mision_1_1745129295147_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129349967/mision_2_1745129349967_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129360556/mision_6_1745129360556_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129393614/mision_1_1745129393615_IMG_6876.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129397329/mision_1_1745129397329_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129503728/mision_3_1745129503728_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129502831/mision_2_1745129502831_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129540855/mision_4_1745129540855_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129635645/mision_5_1745129635645_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129682256/mision_2_1745129682256_IMG_6880.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129684240/mision_3_1745129684240_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129688602/mision_6_1745129688602_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129725623/mision_3_1745129725623_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129748987/mision_4_1745129748987_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129760996/mision_7_1745129760996_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129785200/mision_5_1745129785202_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129831278/mision_4_1745129831278_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129845505/mision_8_1745129845505_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129879445/mision_6_1745129879445_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129881066/mision_9_1745129881066_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129893967/mision_7_1745129893967_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129893771/mision_5_1745129893771_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129940792/mision_7_1745129940792_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129966365/mision_10_1745129966365_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129969809/mision_8_1745129969809_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745129994895/mision_1_1745129994895_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745130012258/mision_9_1745130012258_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745130073137/mision_10_1745130073138_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745130073501/mision_8_1745130073501_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745130073836/mision_2_1745130073836_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745130141416/mision_9_1745130141416_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745131954884/mision_6_1745131954884_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745132028485/mision_7_1745132028485_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745132099314/mision_8_1745132099314_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745132187419/mision_9_1745132187419_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745132260513/mision_10_1745132260514_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133271542/mision_1_1745133271542_IMG_3124.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133316108/mision_2_1745133316108_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133344100/mision_3_1745133344100_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133382328/mision_4_1745133382328_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133414706/mision_5_1745133414706_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133448108/mision_6_1745133448108_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133492433/mision_7_1745133492433_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133518415/mision_8_1745133518415_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133554770/mision_9_1745133554770_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133580632/mision_10_1745133580632_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133900949/mision_3_1745133900949_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133904909/mision_3_1745133904909_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133894170/mision_10_1745133894170_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133937233/mision_4_1745133937233_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133951792/mision_5_1745133951792_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133952274/mision_4_1745133952274_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133976111/mision_6_1745133976111_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745133998798/mision_5_1745133998798_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134009170/mision_7_1745134009170_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134025899/mision_1_1745134025899_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134029454/mision_8_1745134029454_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134036257/mision_1_1745134036257_IMG_7261.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134048702/mision_9_1745134048703_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134043713/mision_6_1745134043713_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134052704/mision_2_1745134052704_IMG_5158.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134056808/mision_3_1745134056808_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134053219/mision_2_1745134053219_IMG_7260.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134063338/mision_3_1745134063338_IMG_5103.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134075973/mision_4_1745134075973_IMG_5081.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134078977/mision_10_1745134078977_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134081964/mision_3_1745134081964_IMG_7258.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134092288/mision_5_1745134092288_IMG_5069.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134092919/mision_4_1745134092919_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134106279/mision_6_1745134106279_IMG_5067.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134102921/mision_4_1745134102921_IMG_7257.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134123464/mision_7_1745134123464_IMG_5028.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134121953/mision_5_1745134121953_IMG_7256.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134096802/mision_7_1745134096802_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134142042/mision_8_1745134142042_IMG_5046.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134138626/mision_6_1745134138626_IMG_7255.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134154624/mision_9_1745134154624_IMG_5010.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134157437/mision_5_1745134157437_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134157328/mision_7_1745134157328_IMG_7254.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134166491/mision_10_1745134166491_IMG_5166.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134171544/mision_8_1745134171544_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134202223/mision_8_1745134202223_IMG_7263.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134214975/mision_1_1745134214975_IMG_4043.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134216348/mision_9_1745134216348_IMG_7252.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134218107/mision_6_1745134218107_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134226752/mision_9_1745134226752_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134231003/mision_2_1745134231003_IMG_4044.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134236209/mision_10_1745134236209_IMG_7251.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134268552/mision_10_1745134268552_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134274715/mision_7_1745134274715_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134295422/mision_3_1745134295422_IMG_4045.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134342668/mision_4_1745134342668_IMG_4046.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134358192/mision_8_1745134358192_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134463411/mision_9_1745134463411_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134467982/mision_5_1745134467982_IMG_4050.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134520847/mision_6_1745134520847_IMG_3476.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134554761/mision_10_1745134554761_image.jpg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134573071/mision_7_1745134573071_IMG_3510.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134632001/mision_8_1745134632001_IMG_3672.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134681282/mision_9_1745134681282_95A24C86-661E-48EC-BA66-6639EECA6D6F.jpeg",
            "https://ojlknkrrxobtiqhhkrad.supabase.co/storage/v1/object/public/pruebas-rally/invitado_1745134785850/mision_10_1745134785850_IMG_4051.jpeg"
        ];

        // --- Elementos del DOM ---
        const galleryContainer = document.getElementById('galleryContainer');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const downloadButton = document.getElementById('downloadButton');
        const selectedCountSpan = document.getElementById('selectedCount');
        const downloadStatus = document.getElementById('downloadStatus');

        // --- Estado de la Aplicación ---
        let selectedImages = new Set(); // Usamos un Set para evitar duplicados y facilitar la gestión

        // --- Funciones ---

        /**
         * Abre el modal y muestra la imagen clickeada.
         * @param {string} src - La URL de la imagen a mostrar.
         */
        function openModal(src) {
            modalImage.src = src;
            imageModal.classList.add('active');
        }

        /**
         * Cierra el modal.
         */
        function closeModal() {
            imageModal.classList.remove('active');
            modalImage.src = ""; // Limpia la imagen para evitar flashes
        }

        /**
         * Actualiza el contador de imágenes seleccionadas y el estado del botón de descarga.
         */
        function updateSelectionUI() {
            const count = selectedImages.size;
            selectedCountSpan.textContent = count;
            downloadButton.disabled = count === 0; // Habilita el botón si hay > 0 seleccionadas
        }

        /**
         * Maneja el cambio de estado de selección de una imagen.
         * @param {Event} event - El evento del checkbox.
         * @param {string} url - La URL de la imagen asociada.
         * @param {HTMLElement} itemDiv - El div contenedor del item de la galería.
         */
        function handleSelectionChange(event, url, itemDiv) {
            const checkbox = event.target;
            if (checkbox.checked) {
                selectedImages.add(url);
                itemDiv.classList.add('selected');
            } else {
                selectedImages.delete(url);
                itemDiv.classList.remove('selected');
            }
            updateSelectionUI();
        }

        /**
         * Crea y añade los elementos de imagen a la galería.
         */
        function populateGallery() {
            galleryContainer.innerHTML = ''; // Limpia la galería antes de poblarla

            if (!imageUrls || imageUrls.length === 0) {
                galleryContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">No hay imágenes para mostrar.</p>';
                return;
            }

            imageUrls.forEach((url, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'gallery-item relative'; // Añadido 'relative' para posicionar checkbox

                const img = document.createElement('img');
                img.src = url;
                img.alt = `Imagen ${index + 1}`;
                img.loading = 'lazy'; // Carga diferida para mejorar rendimiento inicial

                // Placeholder para errores
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'placeholder hidden'; // Oculto inicialmente
                placeholderDiv.textContent = 'Error';

                img.onerror = function() {
                    console.warn("Error al cargar imagen en cuadrícula:", url);
                    img.classList.add('hidden'); // Oculta la imagen rota
                    placeholderDiv.classList.remove('hidden'); // Muestra el placeholder
                    itemDiv.style.cursor = 'not-allowed';
                    // Deshabilitar click y selección para imágenes rotas
                    itemDiv.onclick = null;
                    checkbox.disabled = true;
                    checkbox.style.cursor = 'not-allowed';
                };

                // Evento para abrir modal (solo en la imagen, no en el checkbox)
                img.onclick = (e) => {
                   // Evita abrir el modal si se hizo clic cerca del checkbox (prevención simple)
                   if (e.target === img) {
                       openModal(url);
                   }
                };

                // Checkbox para selección
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'absolute top-2 right-2 z-10 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500'; // Clases de Tailwind para estilo básico
                checkbox.dataset.url = url; // Guarda la URL en el dataset

                // Evento para manejar la selección
                checkbox.onchange = (event) => handleSelectionChange(event, url, itemDiv);

                itemDiv.appendChild(img);
                itemDiv.appendChild(placeholderDiv); // Añadir placeholder al DOM
                itemDiv.appendChild(checkbox); // Añadir checkbox
                galleryContainer.appendChild(itemDiv);
            });
        }

        /**
         * Descarga las imágenes seleccionadas como un archivo ZIP.
         */
        async function downloadSelectedImages() {
            if (selectedImages.size === 0) {
                downloadStatus.textContent = 'No hay imágenes seleccionadas.';
                return;
            }

            downloadButton.disabled = true; // Deshabilita mientras descarga
            downloadStatus.textContent = `Preparando descarga de ${selectedImages.size} imágenes...`;

            const zip = new JSZip();
            let filesAdded = 0;
            const promises = []; // Array para almacenar las promesas de fetch

            selectedImages.forEach(url => {
                const filename = url.substring(url.lastIndexOf('/') + 1);

                // Creamos una promesa para cada fetch
                const fetchPromise = fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            // Si la respuesta no es OK, lanza un error para capturarlo después
                            throw new Error(`Error al descargar ${filename}: ${response.statusText}`);
                        }
                        return response.blob(); // Obtiene el contenido como Blob
                    })
                    .then(blob => {
                        zip.file(filename, blob); // Añade el archivo al ZIP
                        filesAdded++;
                        downloadStatus.textContent = `Descargando ${filesAdded} de ${selectedImages.size}...`;
                    })
                    .catch(error => {
                        // Captura errores de fetch o de respuesta no OK
                        console.error(`Error procesando ${url}:`, error);
                        // Opcional: Podrías añadir un placeholder o info de error al zip
                        // zip.file(`ERROR_${filename}.txt`, `No se pudo descargar: ${error.message}`);
                    });
                promises.push(fetchPromise); // Añade la promesa al array
            });

            try {
                // Espera a que todas las promesas de fetch terminen (incluso si algunas fallan)
                await Promise.allSettled(promises);

                if (filesAdded === 0 && selectedImages.size > 0) {
                     downloadStatus.textContent = 'Error: No se pudo descargar ninguna de las imágenes seleccionadas.';
                     downloadButton.disabled = false; // Rehabilita si falló todo
                     return;
                }

                downloadStatus.textContent = 'Generando archivo ZIP...';
                // Genera el contenido del ZIP como Blob
                zip.generateAsync({ type: "blob" })
                    .then(function(content) {
                        // Usa FileSaver.js para iniciar la descarga
                        saveAs(content, "galeria_seleccion.zip");
                        downloadStatus.textContent = '¡Descarga completa!';
                        // Limpia el estado después de un tiempo
                        setTimeout(() => { downloadStatus.textContent = ''; }, 5000);
                    })
                    .catch(error => {
                         console.error("Error al generar el ZIP:", error);
                         downloadStatus.textContent = 'Error al generar el archivo ZIP.';
                    });

            } catch (error) {
                // Error general durante el proceso (aunque Promise.allSettled debería evitar esto)
                console.error("Error inesperado durante la descarga:", error);
                downloadStatus.textContent = 'Ocurrió un error inesperado durante la descarga.';
            } finally {
                 // Rehabilita el botón si no falló completamente antes
                 if(filesAdded > 0 || selectedImages.size === 0) {
                     downloadButton.disabled = selectedImages.size === 0;
                 }
                 // Considera limpiar la selección después de la descarga si lo deseas
                 // selectedImages.clear();
                 // document.querySelectorAll('.gallery-item.selected').forEach(item => item.classList.remove('selected'));
                 // document.querySelectorAll('.gallery-item input[type="checkbox"]').forEach(cb => cb.checked = false);
                 // updateSelectionUI();
            }
        }


        // --- PWA: Registro del Service Worker ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js') // Asegúrate que la ruta sea correcta
                    .then(registration => {
                        console.log('ServiceWorker registrado con éxito:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Error en el registro del ServiceWorker:', error);
                    });
            });
        }

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            populateGallery();
            updateSelectionUI(); // Estado inicial del botón
            // Cierra el modal si se hace clic fuera de la imagen
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) {
                    closeModal();
                }
            });
            // Asigna el evento al botón de descarga
            downloadButton.addEventListener('click', downloadSelectedImages);
        });

    </script>

    </body>
</html>
